import { BlogPostLayout } from '@/components/BlogPostLayout'
import Image from 'next/image'
// import designSystem from './planetaria-design-system.png'

export const post = {
  draft: true,
  author: 'b5',
  date: '2024-01-05',
  title: 'Iroh connections: What is DERP?',
  description:
    'Designated Encrypted Relay for Packets (DERP) is a protocol for sending encrypted packets between two parties without revealing the IP address of either party to the other. DERP is designed to be used in conjunction with DERP servers, which are trusted third parties that relay DERP packets between clients.',
}

export const metadata = {
  title: post.title,
  description: post.description,
}

export const references = [
    {
        name: 'DERP',
        url: 'https://tailscale.com/blog/what-is-derp/',
    },
    {
        name: 'DERP Protocol',
        url: 'https://tailscale.com/blog/derp-protocol/',
    },
    {
        name: 'DERP Server Map',
        url: 'https://derpmap.tailscale.com/',
    },
    {
        name: 'How NAT traversal works'
        url: 'https://tailscale.com/blog/how-nat-traversal-works',
    }
]

export default (props) => <BlogPostLayout article={post} references={references} {...props} />


## Introduction

    Briefly introduce the concept of P2P networking and the role of NAT traversal.
    Introduce Iroh and its mission to simplify P2P connectivity.
    NAT traversal is a thorny topic that comes up a lot in peer to peer programming. NAT, or Network Address Translation, refers to the process of modifying the network address of an IP header, usually done by a router. Your router will replace your local IP address in your messages, with the public IP address of your router, before sending it off to the internet at large. The router understands how to do this translation and how to make sure that any return messages get routed correctly back to you. But for many routers, this translation only works if your device _initiates_ the connection to the remote device. Some routers will not route messages from remote devices back to you if you have not already sent a message to that remote device. In some cases, the remote device would not even know what IP address to talk to you on anyway!

    This is not a problem in traditional server / client connection relationships, because typically the server has a public IP address that is not behind a NAT device. It is open and free to accept whatever incoming messages it receives. And since the client side of the server / client connection typically initiates communication anyway, the router will allow the server side to respond, no problem.

    In a peer to peer context, however, both devices may be behind NATs! So we often find ourselves in a situation where neither side of the connection can initiate a successful connection, because the other device's router will not let any messages through. NAT traversal is the set of techiques for overcoming this problem. Read more about NATs and NAT traversal techniques in [Tailscale's blog](https://tailscale.com/blog/how-nat-traversal-works), which does an excellent job laying out the different kinds of NATs and methods for hole punching through them.

    Iroh was built to help ease the issues of NAT traversal for developers, allowing you to write peer to peer applications (or server / client applications!) without having to worry that your connections are being blocked by NATs!

    We do this by adapting some protocols and using some techniques written by Tailscale. As a dev using the iroh API to write an app, most of these protocols are not something you need to interact with, they should just work to give you the reliable connectivity you want. There is, however, one protocol that you will see referenced often, and this blog post will describe what it is and how it works. That protocol is the DERP protocol.
    
## The DERP Protocol in Iroh

    The DERP protocol, or Designated Encrypted Relay for Packets, is a protocol designed by Tailscale and is intended to serve a few functions in the hole punching process. 

    It is important to note that DERP servers are servers that run the DERP protocol and are not behind a NAT (so they have public IP addresses that can be dialed by anyone).

    The DERP protocol is responsible for a few steps in the NAT traversal process.

    First, it acts as a STUN server, which tells your device all of the IP address information about itself. This is a vital step in the hole punching / NAT traversal process, since you must be able to tell remote devices about your own IP address in order for them to try to contact you.

    Second, it acts as a coordinator between two nodes that are trying talk to each other directly, but cannot due to NATs. The DERP server is connected to both nodes and can send dialing information to both parties, so that each node knows the IP addresses of the other, and can attempt to talk to each other directly using these IP addresses.

    Third, if hole punching fails, the two nodes can use the DERP servers to securely relay their messages to each other.  

    There are a few differences in the Tailscale approach to the one used in iroh. First, in the Tailscale system, the DERP protocol uses HTTPS streams and WireGuard keys. In iroh we use HTTPS streams that send QUIC packets and uses ed25519 PublicKeys for identification.

    But the biggest difference, from an API perspective, is that Tailscale uses DERP regions, geographically close clusters of DERP servers that can act as packet forwarders for one another. You only need to be connected to one node in that region to be effectively connected to all of them. These regions are identified by an ID number and the list of expected DERP regions is maintained and run by Tailscale.

    All dialing of DERP servers uses this region ID, and refers to the list of DERP regions to get the IP address of this region. There are some massive benefits to this for Tailscale and its users. For one, Tailscale can better regulate the use of the DERP servers, ensuring that it's paying customers are using only trusted servers for relaying data. Also, using a single `u8` to be able to identify a region helps reduce message size, compared to a much longer IP address, or, even spicier, a URL that could potentially have an unbounded size.

    When we first implemented the DERP protocol, we used DERP regions in the same way. It quickly became apparent, however, that the regulation and centralization of DERP regions did not make sense for our usecase. First, it placed undue burden on our users to understand the topography of our network of DERP servers, understand the difference between DERP regions and DERP servers, and obscure the actual IP addresses of where their data was being proxied. It also made it very difficult for an advanced user to run their own DERP server, or to even set up a convenient local DERP server while developing.

    We instead replaced the notion of DERP regions and their ids with DERP urls, normal URLs that indicate where the DERP server is located.

    In our APIs, you will notice certain builders and dialers take an optional DERP URL parameter. You can also see `--derp-url` flags in our iroh CLI options. You can use these parameters and flags to specify a URL that you want to act as your DERP server. 


## Advancements in Connection Establishment

    Elaborate on Iroh's modifications to connect users discovered in the wild.
    Explain the significance of using DERP URLs and how it improves connection flexibility and reliability.

## NodeIDs and ED25519 Key

    Describe the concept of a NodeID in Iroh's system.
    Explain how NodeIDs are derived from ED25519 keys and their role in secure and efficient connection establishment.

## Conclusion

    Summarize the benefits of Iroh's approach to the DERP protocol, highlighting ease of use, enhanced connectivity, and security.
    Encourage readers to explore Iroh for a streamlined P2P experience.
